# 创作编辑器 - 技术开发方案

## 1. 项目概述

本项目旨在开发一款功能强大的本地化创作编辑器，专为小说、故事创作者设计。应用以单机、离线使用为核心，所有数据（文稿、大纲、设定等）均存储在用户本地，确保数据隐私与安全。其核心功能包括大纲设计、思维导图式角色关系管理、智能写作辅助、以及无干扰的专注写作模式。

## 2. 技术选型 (Tech Stack)

为了实现跨平台桌面应用、丰富的交互界面和高效的本地文件操作，推荐以下技术栈：

- **核心框架**: **Electron**
  - **理由**: 将基于 Web 技术的应用打包为跨平台（Windows, macOS, Linux）的桌面应用。能够直接访问本地文件系统（Node.js `fs` 模块），完美契合项目需求。

- **前端框架**: **React** + **TypeScript**
  - **理由**: React 的组件化思想非常适合构建本项目复杂的 UI 界面，便于模块化开发与维护。TypeScript 提供静态类型检查，能显著提升代码质量和开发效率，减少运行时错误。

- **UI 组件库**: **Material-UI (MUI)**
  - **理由**: 提供一套丰富、美观且高度可定制的 React 组件，可快速构建现代化、专业的用户界面。

- **状态管理**: **Redux Toolkit**
  - **理由**: 作为 React 官方推荐的状态管理方案，它能以可预测、可维护的方式管理整个应用的复杂状态（如编辑器内容、大纲数据、用户信息等），并简化 Redux 的样板代码。

- **富文本/Markdown 编辑器**: **TipTap**
  - **理由**: 一个功能强大、无头 (headless) 且可高度扩展的富文本编辑器框架。它基于 Prosemirror，性能优秀，支持 Markdown、实时协作、自定义节点等高级功能，非常适合作为本项目的核心编辑器。

- **思维导图/节点编辑器**: **React Flow**
  - **理由**: 用于构建基于节点的图形界面。非常适合实现 `REQ-011` 中的角色关系图功能，支持拖拽、缩放、自定义节点和边，能与 React 应用无缝集成。

- **本地数据存储**:
  - **文件系统**: 直接使用 Electron 内置的 Node.js `fs` 模块来读写 Markdown、JSON 等格式的本地文件。
  - **结构化数据**: 可选用 **LowDB**，一个基于单个 JSON 文件的轻量级本地数据库，适合管理知识库、设定等结构化数据，操作简单。

## 3. 系统架构

采用 Electron 的主进程 (Main) 和渲染进程 (Renderer) 分离的经典架构。

- **主进程 (`electron/main.ts`)**:
  - **职责**:
    - 创建和管理应用窗口 (`BrowserWindow`)。
    - 处理所有与操作系统交互的本地 API 调用，尤其是**文件系统操作**（读、写、保存、版本管理）。
    - 创建原生应用菜单（文件、编辑、视图等）。
    - 监听来自渲染进程的 IPC (Inter-Process Communication) 请求，并执行相应操作。
  - **安全**: 使用 `contextBridge` 将安全的 API 暴露给渲染进程，而不是直接暴露 `require` 或 `fs`。

- **渲染进程 (`src/`)**:
  - **职责**:
    - 运行完整的 React 应用，负责所有 UI 的渲染和交互。
    - 管理应用的前端状态（Redux Store）。
    - 当需要读写文件时，通过预先暴露的 API (`window.electronAPI`) 向主进程发送 IPC 请求。
    - 实现所有业务逻辑模块，如大纲、思维导图、文本编辑器等。

### 目录结构建议

```
/CreationEditor
├── electron/
│   └── main.ts         # Electron 主进程入口
├── public/
│   └── index.html      # HTML 模板
├── src/
│   ├── api/              # 封装与主进程的 IPC 通信
│   ├── app/              # Redux Store 配置
│   ├── components/       # 通用、可复用的 UI 组件
│   ├── features/         # 各功能模块（切片）
│   │   ├── editor/       # 核心编辑器
│   │   ├── outline/      # 大纲模块
│   │   ├── mindmap/      # 思维导图模块
│   │   └── ...
│   ├── hooks/            # 自定义 React Hooks
│   ├── styles/           # 全局样式
│   └── index.tsx         # React 应用入口
├── package.json
└── tsconfig.json
```

## 4. 模块设计与开发路线图

### 阶段 1：基础编辑器平台 (高优先级)

1.  **环境搭建**:
    - 初始化 Electron + React + TypeScript 项目。
    - 集成 MUI 和 Redux Toolkit。

2.  **`TASK-A02`: 综合文本编辑器构建**:
    - **主进程**: 在 `main.ts` 中实现文件操作 API（`openFile`, `saveFile`, `saveFileAs`），并通过 `contextBridge` 暴露给渲染进程。
    - **渲染进程**:
      - 在 `features/editor/` 中，使用 **TipTap** 构建核心编辑器组件。
      - 实现 `REQ-018` 的基础功能：新建、打开、保存文件（通过调用主进程 API）。
      - 实现 `REQ-016` (字数统计)，利用 TipTap 的 API 实时获取字数并显示。
      - 实现简单的自动保存机制（定时调用保存 API）。

### 阶段 2：核心创作功能 (高优先级)

1.  **`TASK-B01`: 大纲模块**:
    - **数据结构**: 在 Redux Store 中创建 `outline` 切片，用于管理章节数组（`{id, title, content, children}`）。
    - **UI**: 在 `features/outline/` 中创建 `OutlinePanel` 组件，渲染章节列表。
    - **交互**: 实现章节的增、删、改。使用 `dnd-kit` 等库实现拖拽排序。数据变动后同步更新 Redux Store。

2.  **`TASK-B01`: 角色关系图 (思维导图)**:
    - **UI**: 在 `features/mindmap/` 中，使用 **React Flow** 搭建画布。
    - **数据联动**:
      - 创建 `mindmap` Redux 切片来管理节点和边。
      - 监听 `outline` 数据的变化，自动在图中增删改角色节点。
      - 用户在图中修改节点（如重命名角色），应反向更新 `outline` 和 `knowledgeBase` 中的数据。

3.  **`TASK-B03`: 设定与知识库**:
    - **数据存储**: 使用 **LowDB** 或简单的 JSON 文件作为本地知识库。
    - **UI**: 创建 `features/knowledgeBase` 模块，包含分类、标签、搜索栏和内容编辑区。
    - **功能**: 实现 `REQ-013` 和 `REQ-017` 的设定管理和关键词检索功能。

### 阶段 3：语言优化与辅助功能 (中等优先级)

1.  **`TASK-C01`: 错别字与润色**:
    - **集成**: 寻找合适的 JavaScript 离线拼写检查库（如 `node-spellchecker` 的 Web 变体）或 API。
    - **实现**: 创建 TipTap 插件，在用户输入时进行文本分析，并用装饰 (Decorations) 的方式高亮错别字或待优化段落。

2.  **`TASK-B02`: 剧情联想**:
    - **实现**: 设计一个简单的 UI，用户输入文本后，调用预设的规则引擎或一个轻量级的本地 AI 模型接口，返回建议列表。

3.  **`TASK-C02`: 文本转语音 (TTS)**:
    - **集成**: 使用 Web Speech API (`speechSynthesis`) 作为基础实现，或集成更强大的离线 TTS 库。
    - **UI**: 提供播放、暂停、调节语速和音调的控件。

### 阶段 4：体验优化 (高/低优先级)

1.  **`TASK-D02`: 小黑屋 (专注写作模式) (高优先级)**:
    - **状态管理**: 在 Redux 中添加 `focusMode` 状态 (`{isActive, target, currentCount}`)。
    - **UI**: 创建一个全屏浮层 (Modal)，内部只包含核心编辑器和字数进度条。
    - **逻辑**: 激活时，隐藏主界面其他 UI 元素，监听字数统计，达到目标后自动解除并显示祝贺信息。

2.  **`TASK-D01`: 锁定阅读模式 (低优先级)**:
    - **实现**: 这是一个纯前端的 UI 状态切换。激活时，将 TipTap 编辑器设置为只读模式 (`editable: false`)，并可以切换全屏和夜间主题。
